<!DOCTYPE html>
<html lang="en">
  <head>
    {% load static %}
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Ferreteria Santa Rita</title>
    <link
      href="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/style.min.css"
      rel="stylesheet"
    />
    <link href="{% static 'principal/css/styles.css'%}?v=1" rel="stylesheet" />
    <script
      src="https://use.fontawesome.com/releases/v6.3.0/js/all.js"
      crossorigin="anonymous"
    ></script>
  </head>
  <body class="sb-nav-fixed">
    <nav class="sb-topnav navbar navbar-expand navbar-dark bg-dark">
      <!-- Navbar Brand-->
      <a class="navbar-brand ps-3" id="navbarBrand" href="{% url 'dashboard' %}">
        <i class="fas fa-tools" style="margin-right:8px;"></i>
        Ferreteria Santa Rita
      </a>

      <!-- Sidebar Toggle-->
      <button
        class="btn btn-link btn-sm order-1 order-lg-0 me-4 me-lg-0"
        id="sidebarToggle"
        href="#!"
      >
        <i class="fas fa-bars"></i>
      </button>
      <div class="ms-auto me-5 me-lg-4">
        <ul class="navbar-nav align-items-center">
          <li class="nav-item dropdown">
            <a
              class="nav-link dropdown-toggle d-flex align-items-center"
              id="navbarDropdown"
              href="#"
              role="button"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              <span class="navbar-text text-white me-2">{{ user.username }}</span>
              {% if user.is_superuser %}
                <img src="{% static 'principal/assets/img/superadmin.png' %}" alt="Superadmin" style="width:32px;height:32px;border-radius:50%;object-fit:cover;border:2px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,0.10);">
              {% elif user.is_staff %}
                <img src="{% static 'principal/assets/img/administrador.png' %}" alt="Administrador" style="width:32px;height:32px;border-radius:50%;object-fit:cover;border:2px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,0.10);">
              {% else %}
                <img src="{% static 'principal/assets/img/vendedor.png' %}" alt="Vendedor" style="width:32px;height:32px;border-radius:50%;object-fit:cover;border:2px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,0.10);">
              {% endif %}
            </a>
            <ul
              class="dropdown-menu dropdown-menu-end"
              aria-labelledby="navbarDropdown"
            >
              <li><a class="dropdown-item" href="#" id="btnMiPerfil" data-bs-toggle="modal" data-bs-target="#modalMiPerfil">Mi Perfil</a></li>

              <li><hr class="dropdown-divider" /></li>
              <li>
                <a class="dropdown-item" href="{% url 'logout' %}"
                  >Cerrar Sesion</a
                >
              </li>
            </ul>
          </li>
        </ul>
      </div>

  </nav>

    <div id="layoutSidenav">
      <div id="layoutSidenav_nav">
        <nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
          <div class="sb-sidenav-menu">
            <div class="nav">
              <!-- Navbar Search-->
              <div class="sb-sidenav-menu-heading">
                <form
                  class="d-none d-md-inline-block form-inline ms-auto me-0 me-md-3 my-2 my-md-0"
                >
                  <div class="input-group">
                    <input
                      id="navbarSearch"
                      class="form-control"
                      type="text"
                      placeholder="Buscar"
                      aria-label="Buscar"
                      aria-describedby="btnNavbarSearch"
                    />
                    <button
                      class="btn btn-primary"
                      id="btnNavbarSearch"
                      type="button"
                    >
                      <i class="fas fa-search"></i>
                    </button>
                  </div>
                </form>
              </div>
              <div class="sb-sidenav-menu-heading">Principal</div>
              <a class="nav-link" href="{% url 'dashboard'%}">
                <div class="sb-nav-link-icon">
                  <i class="fas fa-tachometer-alt"></i>
                </div>
                Inicio
              </a>
              {# Solo los usuarios que sean exclusivamente vendedores (no staff ni superuser) est√°n limitados. #}
              {% if not es_vendedor or user.is_superuser or user.is_staff %}
              <a
                class="nav-link collapsed"
                href="#"
                data-bs-toggle="collapse"
                data-bs-target="#collapseLayouts"
                aria-expanded="false"
                aria-controls="collapseLayouts"
              >
                <div class="sb-nav-link-icon">
                  <i class="fas fa-columns"></i>
                </div>
                Usuarios
                <div class="sb-sidenav-collapse-arrow">
                  <i class="fas fa-angle-down"></i>
                </div>
              </a>
              <div
                class="collapse"
                id="collapseLayouts"
                aria-labelledby="headingOne"
                data-bs-parent="#sidenavAccordion"
              >
                <nav class="sb-sidenav-menu-nested nav">
                  <a
                    class="nav-link"
                    href="{% url 'usuarios:listar_usuarios' %}"
                    >Listas de usuarios</a
                  >
                  <a class="nav-link" href="{% url 'usuarios:nuevo_usuario' %}"
                    >Ingresar nuevo usuario</a
                  >
                </nav>
              </div>
              {% endif %}
                              {% if not es_vendedor or user.is_superuser or user.is_staff %}
              <a
                class="nav-link collapsed"
                href="#"
                data-bs-toggle="collapse"
                data-bs-target="#collapseProductos"
                aria-expanded="false"
                aria-controls="collapseProductos"
              >
                <div class="sb-nav-link-icon">
                  <i class="fas fa-columns"></i>
                </div>
                Productos
                <div class="sb-sidenav-collapse-arrow">
                  <i class="fas fa-angle-down"></i>
                </div>
              </a>
              <div
                class="collapse"
                id="collapseProductos"
                aria-labelledby="headingOne"
                data-bs-parent="#sidenavAccordion"
              >
                <nav class="sb-sidenav-menu-nested nav">
                  <a class="nav-link" href="{% url 'mis_articulos' %}"
                    >Lista de productos</a
                  >
                  <a class="nav-link" href="{% url 'categorias'%}"
                    >Categorias de productos</a
                  >
                </nav>
              </div>
              {% endif %}
              <a
              class="nav-link collapsed"
              href="#"
              data-bs-toggle="collapse"
              data-bs-target="#collapsePedidos"
              aria-expanded="false"
              aria-controls="collapsePedidos"
            >
              <div class="sb-nav-link-icon">
                <i class="fas fa-truck"></i>
              </div>
              Pedidos
              <div class="sb-sidenav-collapse-arrow">
                <i class="fas fa-angle-down"></i>
              </div>
            </a>
            <div
              class="collapse"
              id="collapsePedidos"
              aria-labelledby="headingPedidos"
              data-bs-parent="#sidenavAccordion"
            >
              <nav class="sb-sidenav-menu-nested nav">
                <a class="nav-link" href="{% url 'listar_pedidos' %}">
                  Lista de pedidos
                </a>
                <a class="nav-link" href="{% url 'nuevo_pedido' %}">
                    Nuevo pedido
                </a>
              </nav>
            </div>
              <a
                class="nav-link collapsed"
                href="#"
                data-bs-toggle="collapse"
                data-bs-target="#collapseProveedores"
                aria-expanded="false"
                aria-controls="collapseProveedores"
              >
                <div class="sb-nav-link-icon">
                  <i class="fas fa-book-open"></i>
                </div>
                Proveedores
                <div class="sb-sidenav-collapse-arrow">
                  <i class="fas fa-angle-down"></i>
                </div>
              </a>
              <div
                class="collapse"
                id="collapseProveedores"
                aria-labelledby="headingTwo"
                data-bs-parent="#sidenavAccordion"
              >
                <nav class="sb-sidenav-menu-nested nav">
                  <a class="nav-link" href="{% url 'mis_proveedores' %}">
                    Lista de proveedores
                  </a>
                </nav>
              </div>
                              {% if not es_vendedor or user.is_superuser or user.is_staff %}
              <a
                class="nav-link collapsed"
                href="#"
                data-bs-toggle="collapse"
                data-bs-target="#collapseEstacionalidades"
                aria-expanded="false"
                aria-controls="collapseEstacionalidades"
              >
                <div class="sb-nav-link-icon">
                  <i class="fas fa-book-open"></i>
                </div>
                Estacionalidades
                <div class="sb-sidenav-collapse-arrow">
                  <i class="fas fa-angle-down"></i>
                </div>
              </a>
              <div
                class="collapse"
                id="collapseEstacionalidades"
                aria-labelledby="headingTwo"
                data-bs-parent="#sidenavAccordion"
              >
                <nav class="sb-sidenav-menu-nested nav">
                  <a class="nav-link" href="{% url 'mis_estacionalidades' %}">
                    Lista de estacionalidades
                  </a>
                </nav>
              </div>
              {% endif %}
                            {% if not es_vendedor or user.is_superuser or user.is_staff %}
              <a
                class="nav-link collapsed"
                href="#"
                data-bs-toggle="collapse"
                data-bs-target="#collapseFormasPago"
                aria-expanded="false"
                aria-controls="collapseFormasPago"
              >
                <div class="sb-nav-link-icon">
                  <i class="fas fa-credit-card"></i>
                </div>
                Formas de Pago
                <div class="sb-sidenav-collapse-arrow">
                  <i class="fas fa-angle-down"></i>
                </div>
              </a>
              <div
                class="collapse"
                id="collapseFormasPago"
                aria-labelledby="headingFormasPago"
                data-bs-parent="#sidenavAccordion"
              >
                <nav class="sb-sidenav-menu-nested nav">
                  <a class="nav-link" href="{% url 'mis_formasdepago' %}">
                    Lista de formas de pago
                  </a>
                  <a class="nav-link" href="{% url 'nueva_formadepago' %}">
                    Nueva forma de pago
                  </a>
                </nav>
              </div>
              {% endif %}

                            {% if not es_vendedor or user.is_superuser or user.is_staff %}
              <a
                class="nav-link collapsed"
                href="#"
                data-bs-toggle="collapse"
                data-bs-target="#collapseIva"
                aria-expanded="false"
                aria-controls="collapseIva"
              >
                <div class="sb-nav-link-icon">
                  <i class="fas fa-credit-card"></i>
                </div>
                IVA
                <div class="sb-sidenav-collapse-arrow">
                  <i class="fas fa-angle-down"></i>
                </div>
              </a>
              <div
                class="collapse"
                id="collapseIva"
                aria-labelledby="headingIva"
                data-bs-parent="#sidenavAccordion"
              >
                <nav class="sb-sidenav-menu-nested nav">
                  <a class="nav-link" href="{% url 'mis_iva' %}">
                    Lista de IVA
                  </a>
                  <a class="nav-link" href="{% url 'nuevo_iva' %}">
                    Nuevo IVA
                  </a>
                </nav>
              </div>
              {% endif %}
                            {% if not es_vendedor or user.is_superuser or user.is_staff %}
                <a
                class="nav-link collapsed"
                href="#"
                data-bs-toggle="collapse"
                data-bs-target="#collapseMoneda"
                aria-expanded="false"
                aria-controls="collapseMoneda"
              >
                <div class="sb-nav-link-icon">
                  <i class="fas fa-credit-card"></i>
                </div>
                Moneda
                <div class="sb-sidenav-collapse-arrow">
                  <i class="fas fa-angle-down"></i>
                </div>
              </a>
              <div
                class="collapse"
                id="collapseMoneda"
                aria-labelledby="headingMoneda"
                data-bs-parent="#sidenavAccordion"
              >
                <nav class="sb-sidenav-menu-nested nav">
                  <a class="nav-link" href="{% url 'mis_monedas' %}">
                    Lista de Monedas
                  </a>
                  <a class="nav-link" href="{% url 'nueva_moneda' %}">
                    Nuevo Moneda
                  </a>
                </nav>
              </div>
              {% endif %}
              {% if not es_vendedor or user.is_superuser or user.is_staff %}
                <a
                class="nav-link collapsed"
                href="#"
                data-bs-toggle="collapse"
                data-bs-target="#collapseCondicionFiscal"
                aria-expanded="false"
                aria-controls="collapseCondicionFiscal"
              >
                <div class="sb-nav-link-icon">
                  <i class="fas fa-credit-card"></i>
                </div>
                Condicion Fiscal
                <div class="sb-sidenav-collapse-arrow">
                  <i class="fas fa-angle-down"></i>
                </div>
              </a>
              <div
                class="collapse"
                id="collapseCondicionFiscal"
                aria-labelledby="headingcCondicionFiscal"
                data-bs-parent="#sidenavAccordion"
              >
                <nav class="sb-sidenav-menu-nested nav">
                  <a class="nav-link" href="{% url 'mis_condiciones_fiscales' %}">
                    Lista de Condiciones Fiscales
                  </a>
                  <a class="nav-link" href="{% url 'nueva_condicion_fiscal' %}">
                    Nueva Condicion Fiscal
                  </a>
                </nav>
              </div>
              {% endif %}
               <a
                class="nav-link collapsed"
                href="#"
                data-bs-toggle="collapse"
                data-bs-target="#collapseClientes"
                aria-expanded="false"
                aria-controls="collapseClientes"
              >
                <div class="sb-nav-link-icon">
                  <i class="fas fa-credit-card"></i>
                </div>
                Clientes
                <div class="sb-sidenav-collapse-arrow">
                  <i class="fas fa-angle-down"></i>
                </div>
              </a>
              <div
                class="collapse"
                id="collapseClientes"
                aria-labelledby="headingClientes"
                data-bs-parent="#sidenavAccordion"
              >
                <nav class="sb-sidenav-menu-nested nav">
                  <a class="nav-link" href="{% url 'mis_clientes' %}">
                    Lista de Clientes
                  </a>
                  <a class="nav-link" href="{% url 'nuevo_cliente' %}">
                    Nuevo Cliente
                  </a>
                </nav>
              </div>
              <div class="sb-sidenav-menu-heading">Registros</div>
               <a
                class="nav-link collapsed"
                href="#"
                data-bs-toggle="collapse"
                data-bs-target="#collapseVentas"
                aria-expanded="false"
                aria-controls="collapseVentas"
              >
                <div class="sb-nav-link-icon">
                  <i class="fas fa-credit-card"></i>
                </div>
                Ventas
                <div class="sb-sidenav-collapse-arrow">
                  <i class="fas fa-angle-down"></i>
                </div>
              </a>
              <div
                class="collapse"
                id="collapseVentas"
                aria-labelledby="headingVentas"
                data-bs-parent="#sidenavAccordion"
              >
                <nav class="sb-sidenav-menu-nested nav">
                  <a class="nav-link" href="{% url 'mis_ventas' %}">
                    Lista de Ventas
                  </a>
                  <a class="nav-link" href="{% url 'nueva_venta' %}">
                    Nueva Ventas
                  </a>
                </nav>
              </div>
              <a
                class="nav-link collapsed"
                href="#"
                data-bs-toggle="collapse"
                data-bs-target="#collapseNotas"
                aria-expanded="false"
                aria-controls="collapseNotas"
              >
                <div class="sb-nav-link-icon">
                  <i class="fa-solid fa-file-invoice"></i>
                </div>
                Notas de Cr√©dito
                <div class="sb-sidenav-collapse-arrow">
                  <i class="fas fa-angle-down"></i>
                </div>
              </a>
              <div
                class="collapse"
                id="collapseNotas"
                aria-labelledby="headingNotas"
                data-bs-parent="#sidenavAccordion"
              >
                <nav class="sb-sidenav-menu-nested nav">
                  <a class="nav-link" href="{% url 'mis_notascredito' %}">
                    Lista de Notas de Cr√©dito
                  </a>
                </nav>
              </div>
              {% if not es_vendedor or user.is_superuser or user.is_staff %}
              <a class="nav-link" href="{% url 'base_para_informes' %}">
                <div class="sb-nav-link-icon"><i class="fas fa-table"></i></div>
                Informes
              </a>
              {% endif %}
            </div>
          </div>
          <div class="sb-sidenav-footer">
            <div class="small">Desarrollado por</div>
            Lord of the Code S.A
          </div>
        </nav>
      </div>
      <div id="layoutSidenav_content">
        <main>
          {% block Contenido %}
          <div class="container-fluid px-4">
            <h1 class="mt-4">Bienvenido, {{ user.first_name }} {{ user.last_name }}</h1>
            <ol class="breadcrumb mb-4">
            </ol>
            <hr style="height: 5px; background-color: black; border: none" />
            <div class="row">
              <div class="dashboard-cards row" style="margin-bottom: 30px;">
                <div class="col-xl-3 col-md-6">
                  <div class="dashboard-card dashboard-card-articulos text-center" style="background:#29ABE2;padding:20px 0;border-radius:8px;">
                    <div style="display:flex;align-items:center;justify-content:center;">
                      <i class="fas fa-box" style="font-size:2.5rem;color:#fff;"></i>
                      <span class="dashboard-card-number" style="font-size:2.5rem;font-weight:bold;color:#fff;margin-left:15px;">{{ total_productos }}</span>
                    </div>
                    <div class="dashboard-card-label" style="font-size:1rem;color:#fff;margin-top:10px;">Productos totales</div>
                  </div>
                </div>
                <div class="col-xl-3 col-md-6">
                  <div class="dashboard-card dashboard-card-categorias text-center" style="background:#F15A29;padding:20px 0;border-radius:8px;">
                    <div style="display:flex;align-items:center;justify-content:center;">
                      <i class="fas fa-building" style="font-size:2.5rem;color:#fff;"></i>
                      <span class="dashboard-card-number" style="font-size:2.5rem;font-weight:bold;color:#fff;margin-left:15px;">{{ total_proveedores }}</span>
                    </div>
                    <div class="dashboard-card-label" style="font-size:1rem;color:#fff;margin-top:10px;">Proveedores registrados</div>
                  </div>
                </div>
                <div class="col-xl-3 col-md-6">
                  <div class="dashboard-card dashboard-card-productos text-center" style="background:#7AC943;padding:20px 0;border-radius:8px;">
                    <div style="display:flex;align-items:center;justify-content:center;">
                      <i class="fa-solid fa-file-invoice-dollar" style="font-size:2.5rem;color:#fff;"></i>
                      <span class="dashboard-card-number" style="font-size:2.5rem;font-weight:bold;color:#fff;margin-left:15px;">{{ ventas_mes_actual }}</span>
                    </div>
                    <div class="dashboard-card-label" style="font-size:1rem;color:#fff;margin-top:10px;">Ventas realizadas en {{ mes_actual_nombre }}</div>
                  </div>
                </div>
                <div class="col-xl-3 col-md-6">
                  <div class="dashboard-card dashboard-card-ventas text-center" style="background:#FBB03B;padding:20px 0;border-radius:8px;">
                    <div style="display:flex;align-items:center;justify-content:center;">
                      <i class="fas fa-truck" style="font-size:2.5rem;color:#fff;"></i>
                      <span class="dashboard-card-number" style="font-size:2.5rem;font-weight:bold;color:#fff;margin-left:15px;">{{ total_pedidos }}</span>
                    </div>
                    <div class="dashboard-card-label" style="font-size:1rem;color:#fff;margin-top:10px;">Pedidos realizados</div>
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-xl-6">
                <div class="card mb-4" style="height: 370px; display: flex; flex-direction: column;">
                  <div class="card-header">
                    <i class="fas fa-chart-area me-1"></i>
                    Top 10 Productos M√°s Pedidos
                  </div>
                  <div class="card-body">
                    <canvas id="myAreaChart" width="100%" height="40"></canvas>
                  </div>
                </div>
              </div>
              <div class="col-xl-6">
                <div class="card mb-4" style="height: 370px; display: flex; flex-direction: column;">
                  <div class="card-header">
                    <i class="fas fa-table me-1"></i>
                    Productos por debajo del stock m√≠nimo
                  </div>
                  <div class="card-body">
                    <div class="table-responsive" style="flex: 1 1 auto; max-height: 250px; overflow-y: auto;">
                      <table class="table table-bordered mb-0">
                        <thead style="background-color: orange; color: white;">
                          <tr>
                            <th style="background-color: orange; color: white;">Producto</th>
                            <th style="background-color: orange; color: white;">Stock actual</th>
                            <th style="background-color: orange; color: white;">Stock m√≠nimo</th>
                          </tr>
                        </thead>
                        <tbody id="tabla-stock-minimo">
                          <tr id="mensaje-stock-vacio">
                            <td colspan="3" class="text-center">Todos los productos est√°n por encima del stock m√≠nimo</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endblock Contenido %}
        </main>
        <footer class="py-4 bg-light mt-auto">
          {% block footer %} {% endblock footer %}
          <div class="container-fluid px-4">
            <div
              class="d-flex align-items-center justify-content-between small"
            >
              <div class="text-muted">Copyright &copy; LOTC S.A - 2025</div>
              <div>
                <a href="#">Privacy Policy</a>
                &middot;
                <a href="#">Terms &amp; Conditions</a>
              </div>
            </div>
          </div>
        </footer>
      </div>
    </div>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>

    <!-- Modal Mi Perfil (mover justo antes de </body>) -->
    <div class="modal fade" id="modalMiPerfil" tabindex="-1" aria-labelledby="modalMiPerfilLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalMiPerfilLabel">Mi Perfil</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <style>
              .modal-modern-bg {
                background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%);
                min-height: 100vh;
                padding: 0;
                display: flex;
                flex-direction: column;
                justify-content: flex-start;
                height: 100%;
              }
              .perfil-modern-card {
                background: #fff;
                border-radius: 18px;
                box-shadow: 0 6px 32px 0 rgba(44,62,80,0.13);
                padding: 2rem 2.5rem 1.2rem 2.5rem;
                margin: 0 auto 0.5rem auto;
                max-width: 650px;
                position: relative;
              }
              .perfil-img-circulo {
                width: 110px;
                height: 110px;
                border-radius: 50%;
                border: 4px solid #fff;
                box-shadow: 0 2px 12px rgba(0,0,0,0.13);
                display: flex;
                align-items: center;
                justify-content: center;
                margin: -70px auto 1.2rem auto;
                overflow: hidden;
                background: linear-gradient(135deg, #ffb347 0%, #ffcc80 100%);
                position: relative;
                transition: box-shadow 0.2s;
              }
              .perfil-img-circulo img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                border-radius: 50%;
                border: 2px solid #fff;
              }
              .perfil-img-circulo::after {
                content: '';
                position: absolute;
                top: -6px; left: -6px; right: -6px; bottom: -6px;
                border-radius: 50%;
                border: 2px solid #ff8800;
                opacity: 0.18;
                pointer-events: none;
                transition: opacity 0.2s;
              }
              .perfil-img-circulo:hover {
                box-shadow: 0 4px 24px 0 rgba(255,136,0,0.18);
              }
              .perfil-form-label {
                font-weight: 600;
                color: #ff8800;
                margin-bottom: 0.2rem;
                font-size: 0.98rem;
              }
              .perfil-form-input {
                width: 100%;
                border: 1.5px solid #e0e0e0;
                border-radius: 6px;
                padding: 7px 12px;
                background: #f7f7fa;
                color: #444;
                font-size: 1.04rem;
                margin-bottom: 1rem;
                box-shadow: none;
                transition: border 0.2s;
              }
              .perfil-form-input[disabled] {
                background: #f3f3f3;
                color: #888;
                font-weight: 500;
              }
              .perfil-btns-top {
                display: flex;
                gap: 0.7rem;
                margin-bottom: 1.2rem;
                justify-content: flex-end;
              }
              .perfil-btn-editar {
                background: #fff;
                color: #28a745 !important;
                border: 1.5px solid #28a745 !important;
                font-weight: 600;
                border-radius: 6px;
                transition: background 0.2s, color 0.2s;
              }
              .perfil-btn-editar:hover {
                background: #28a745 !important;
                color: #fff !important;
              }
              .perfil-btn-cambiar {
                background: #fff;
                color: #ff8800 !important;
                border: 1.5px solid #ff8800 !important;
                font-weight: 600;
                border-radius: 6px;
                transition: background 0.2s, color 0.2s;
              }
              .perfil-btn-cambiar:hover {
                background: #ff8800 !important;
                color: #fff !important;
              }
              .perfil-modern-card .badge {
                font-size: 1rem;
                font-weight: 600;
                letter-spacing: 1px;
                box-shadow: 0 1px 4px rgba(44,62,80,0.08);
              }
            </style>
            <div class="modal-modern-bg" style="padding:0;margin:0;">
                <div class="perfil-modern-card">
                  <div class="perfil-img-circulo">
                    {% if user.is_superuser %}
                      <img src="{% static 'principal/assets/img/superadmin.png' %}" alt="Superadmin" />
                    {% elif user.is_staff %}
                      <img src="{% static 'principal/assets/img/administrador.png' %}" alt="Administrador" />
                    {% else %}
                      <img src="{% static 'principal/assets/img/vendedor.png' %}" alt="Vendedor" />
                    {% endif %}
                  </div>
                  <div class="perfil-btns-top" id="perfilBtnsTop">
                    <button type="button" class="btn perfil-btn-editar" id="btnEditarPerfil">
                      <i class="fa fa-edit me-1"></i> Editar
                    </button>
                    <button type="button" class="btn perfil-btn-cambiar" id="btnCambiarPass">
                      <i class="fa fa-key me-1"></i> Cambiar contrase√±a
                    </button>
                  </div>
                  <form id="perfilForm" autocomplete="off">
                    <div id="perfilCamposLectura">
                      <label class="perfil-form-label">Nombre</label>
                      <input type="text" class="perfil-form-input" name="first_name" id="perfilNombre" value="{{ user.first_name }}" disabled>
                      <label class="perfil-form-label">Apellido</label>
                      <input type="text" class="perfil-form-input" name="last_name" id="perfilApellido" value="{{ user.last_name }}" disabled>
                      <label class="perfil-form-label">Usuario</label>
                      <input type="text" class="perfil-form-input" name="username" id="perfilUsuario" value="{{ user.username }}" disabled>
                      <label class="perfil-form-label">Email</label>
                      <input type="email" class="perfil-form-input" name="email" id="perfilEmail" value="{{ user.email }}" disabled>
                      <label class="perfil-form-label">Rol/es</label>
                      <input type="text" class="perfil-form-input" disabled
                        value="{% if user.is_superuser %}üëë Superadmin{% endif %}{% if user.is_superuser and user.is_staff %}, {% endif %}{% if user.is_staff %}Administrador{% endif %}{% if not user.is_superuser and not user.is_staff %}Vendedor{% endif %}">
                      <div class="text-center my-3">
                        {% if user.is_active %}
                          <span class="badge bg-success px-3 py-2">
                            <i class="fa fa-check-circle me-1"></i> Activo
                          </span>
                        {% else %}
                          <span class="badge bg-danger px-3 py-2">
                            <i class="fa fa-times-circle me-1"></i> Inactivo
                          </span>
                        {% endif %}
                      </div>
                    </div>
                    <div id="perfilCamposEdicion" style="display:none;">
                      <label class="perfil-form-label">Nombre</label>
                      <input type="text" class="perfil-form-input" name="first_name" id="perfilNombreEdit" value="{{ user.first_name }}" disabled>
                      <label class="perfil-form-label">Apellido</label>
                      <input type="text" class="perfil-form-input" name="last_name" id="perfilApellidoEdit" value="{{ user.last_name }}" disabled>
                    </div>
                    <div class="perfil-btns-top" id="perfilBtnsGuardar" style="display:none;">
                      <button type="button" class="btn btn-success" id="btnGuardarPerfil">
                        <i class="fa fa-save me-1"></i> Guardar
                      </button>
                      <button type="button" class="btn btn-secondary" id="btnCancelarPerfil">
                        Cancelar
                      </button>
                    </div>
                    <div id="perfilMsg" class="mt-2"></div>
                  </form>
                  <!-- Formulario de cambio de contrase√±a -->
                  <form id="formCambioPass" autocomplete="off" style="display:none;">
                    <label class="perfil-form-label">Contrase√±a actual</label>
                    <input type="password" class="perfil-form-input" name="old_password" id="passActual" autocomplete="current-password">
                    <label class="perfil-form-label">Nueva contrase√±a</label>
                    <input type="password" class="perfil-form-input" name="new_password1" id="passNueva" autocomplete="new-password">
                    <label class="perfil-form-label">Confirmar nueva contrase√±a</label>
                    <input type="password" class="perfil-form-input" name="new_password2" id="passNueva2" autocomplete="new-password">
                    <div class="perfil-btns-top" id="perfilBtnsPass">
                      <button type="button" class="btn btn-success" id="btnGuardarPass">
                        <i class="fa fa-save me-1"></i> Guardar
                      </button>
                      <button type="button" class="btn btn-secondary" id="btnCancelarPass">
                        Cancelar
                      </button>
                    </div>
                    <div id="passMsg" class="mt-2"></div>
                  </form>
<script>
    document.addEventListener('DOMContentLoaded', function() {
      var btnCambiarPass = document.getElementById('btnCambiarPass');
      var formCambioPass = document.getElementById('formCambioPass');
      var btnsPass = document.getElementById('perfilBtnsPass');
      var btnGuardarPass = document.getElementById('btnGuardarPass');
      var btnCancelarPass = document.getElementById('btnCancelarPass');
      var passMsg = document.getElementById('passMsg');
      var passActual = document.getElementById('passActual');
      var passNueva = document.getElementById('passNueva');
      var passNueva2 = document.getElementById('passNueva2');

      if(btnCambiarPass) {
        btnCambiarPass.addEventListener('click', function() {
          divLectura.style.display = 'none';
          divEdicion.style.display = 'none';
          formCambioPass.style.display = 'block';
          btnsTop.style.display = 'none';
          btnsGuardar.style.display = 'none';
          passMsg.textContent = '';
          passMsg.innerHTML = '';
          msg.textContent = '';
          msg.innerHTML = '';
          passActual.value = '';
          passNueva.value = '';
          passNueva2.value = '';
        });
      }
      if(btnCancelarPass) {
        btnCancelarPass.addEventListener('click', function() {
          formCambioPass.style.display = 'none';
          divLectura.style.display = 'block';
          btnsTop.style.display = 'flex';
          passMsg.textContent = '';
          passMsg.innerHTML = '';
        });
      }
      if(btnGuardarPass) {
        btnGuardarPass.addEventListener('click', function() {
          passMsg.innerHTML = '<span class="text-info">Guardando...</span>';
          var data = {
            old_password: passActual.value,
            new_password1: passNueva.value,
            new_password2: passNueva2.value,
            csrfmiddlewaretoken: '{{ csrf_token }}'
          };
          fetch('{% url 'usuarios:cambiar_contrasena_ajax' %}', {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest', 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams(data)
          })
          .then(response => response.json())
          .then(json => {
            if(json.success) {
              passMsg.innerHTML = '<span class="text-success">Contrase√±a cambiada correctamente.</span>';
              formCambioPass.style.display = 'none';
              divLectura.style.display = 'block';
              btnsTop.style.display = 'flex';
            } else {
              let msgError = '';
              if (typeof json.error === 'object') {
                for (const campo in json.error) {
                  let errores = json.error[campo];
                  if (Array.isArray(errores)) {
                    errores.forEach(function(err) {
                      msgError += `<div>${err}</div>`;
                    });
                  } else {
                    msgError += `<div>${errores}</div>`;
                  }
                }
              } else {
                msgError = json.error || 'Error al cambiar la contrase√±a.';
              }
              passMsg.innerHTML = '<span class="text-danger">' + msgError + '</span>';
            }
          })
          .catch(() => {
            passMsg.innerHTML = '<span class="text-danger">Error de red.</span>';
          });
        });
      }
    });
</script>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
    // Unificar l√≥gica de edici√≥n de perfil y cambio de contrase√±a en el modal
    document.addEventListener('DOMContentLoaded', function() {
      // Variables globales del modal
      var btn = document.getElementById('btnMiPerfil');
      var btnEditar = document.getElementById('btnEditarPerfil');
      var btnsGuardar = document.getElementById('perfilBtnsGuardar');
      var btnsTop = document.getElementById('perfilBtnsTop');
      var form = document.getElementById('perfilForm');
      var msg = document.getElementById('perfilMsg');
      var camposLectura = [
        document.getElementById('perfilNombre'),
        document.getElementById('perfilApellido')
      ];
      var camposEdicion = [
        document.getElementById('perfilNombreEdit'),
        document.getElementById('perfilApellidoEdit')
      ];
      var divLectura = document.getElementById('perfilCamposLectura');
      var divEdicion = document.getElementById('perfilCamposEdicion');
      // Cambio de contrase√±a
      var btnCambiarPass = document.getElementById('btnCambiarPass');
      var formCambioPass = document.getElementById('formCambioPass');
      var btnsPass = document.getElementById('perfilBtnsPass');
      var btnGuardarPass = document.getElementById('btnGuardarPass');
      var btnCancelarPass = document.getElementById('btnCancelarPass');
      var passMsg = document.getElementById('passMsg');
      var passActual = document.getElementById('passActual');
      var passNueva = document.getElementById('passNueva');
      var passNueva2 = document.getElementById('passNueva2');

      // Abrir modal: siempre modo solo lectura
      if (btn) {
        btn.addEventListener('click', function(e) {
          divLectura.style.display = 'block';
          divEdicion.style.display = 'none';
          formCambioPass.style.display = 'none';
          btnsTop.style.display = 'flex';
          btnsGuardar.style.display = 'none';
          msg.textContent = '';
          msg.innerHTML = '';
          passMsg.textContent = '';
          passMsg.innerHTML = '';
          // Restaurar valores de solo lectura y edici√≥n
          camposLectura[0].value = "{{ user.first_name|escapejs }}";
          camposLectura[1].value = "{{ user.last_name|escapejs }}";
          camposEdicion[0].value = "{{ user.first_name|escapejs }}";
          camposEdicion[1].value = "{{ user.last_name|escapejs }}";
          camposEdicion.forEach(function(campo) { campo.disabled = true; });
          passActual.value = '';
          passNueva.value = '';
          passNueva2.value = '';
          var modal = document.getElementById('modalMiPerfil');
          if (modal) {
            var modalInstance = bootstrap.Modal.getOrCreateInstance(modal);
            modalInstance.show();
          }
        });
      }

      // Edici√≥n de perfil en el modal
      if(btnEditar) {
        btnEditar.addEventListener('click', function() {
          msg.textContent = '';
          msg.innerHTML = '';
          divLectura.style.display = 'none';
          divEdicion.style.display = 'block';
          formCambioPass.style.display = 'none';
          camposEdicion.forEach(function(campo) { campo.disabled = false; });
          btnsTop.style.display = 'none';
          btnsGuardar.style.display = 'flex';
        });
      }
      var btnCancelar = document.getElementById('btnCancelarPerfil');
      if(btnCancelar) {
        btnCancelar.addEventListener('click', function() {
          camposEdicion[0].value = "{{ user.first_name|escapejs }}";
          camposEdicion[1].value = "{{ user.last_name|escapejs }}";
          camposEdicion.forEach(function(campo) { campo.disabled = true; });
          divEdicion.style.display = 'none';
          divLectura.style.display = 'block';
          formCambioPass.style.display = 'none';
          btnsGuardar.style.display = 'none';
          btnsTop.style.display = 'flex';
          msg.innerHTML = '';
        });
      }
      var btnGuardar = document.getElementById('btnGuardarPerfil');
      if(btnGuardar) {
        btnGuardar.addEventListener('click', function() {
          msg.innerHTML = '<span class="text-info">Guardando...</span>';
          var data = {
            first_name: camposEdicion[0].value,
            last_name: camposEdicion[1].value,
            csrfmiddlewaretoken: '{{ csrf_token }}'
          };
          fetch('{% url 'usuarios:editar_perfil_modal' user.pk %}', {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest', 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams(data)
          })
          .then(response => response.json())
          .then(json => {
            if(json.success) {
              msg.innerHTML = '<span class="text-success">Perfil actualizado correctamente.</span>';
              setTimeout(function() { msg.innerHTML = ''; }, 1000);
              camposEdicion.forEach(function(campo) { campo.disabled = true; });
              divEdicion.style.display = 'none';
              divLectura.style.display = 'block';
              // Actualizar los campos de solo lectura con los nuevos valores
              camposLectura[0].value = camposEdicion[0].value;
              camposLectura[1].value = camposEdicion[1].value;
              btnsGuardar.style.display = 'none';
              btnsTop.style.display = 'flex';
            } else {
              msg.innerHTML = '<span class="text-danger">' + (json.error || 'Error al actualizar.') + '</span>';
              setTimeout(function() { msg.innerHTML = ''; }, 1000);
            }
          })
          .catch(() => {
            msg.innerHTML = '<span class="text-danger">Error de red.</span>';
          });
        });
      }

      // Cambio de contrase√±a en el modal
      if(btnCambiarPass) {
        btnCambiarPass.addEventListener('click', function() {
          divLectura.style.display = 'none';
          divEdicion.style.display = 'none';
          formCambioPass.style.display = 'block';
          btnsTop.style.display = 'none';
          btnsGuardar.style.display = 'none';
          passMsg.textContent = '';
          passMsg.innerHTML = '';
          passActual.value = '';
          passNueva.value = '';
          passNueva2.value = '';
        });
      }
      if(btnCancelarPass) {
        btnCancelarPass.addEventListener('click', function() {
          formCambioPass.style.display = 'none';
          divLectura.style.display = 'block';
          btnsTop.style.display = 'flex';
          passMsg.textContent = '';
          passMsg.innerHTML = '';
        });
      }
      if(btnGuardarPass) {
        btnGuardarPass.addEventListener('click', function() {
          passMsg.innerHTML = '<span class="text-info">Guardando...</span>';
          var data = {
            old_password: passActual.value,
            new_password1: passNueva.value,
            new_password2: passNueva2.value,
            csrfmiddlewaretoken: '{{ csrf_token }}'
          };
          fetch('{% url 'usuarios:cambiar_contrasena_ajax' %}', {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest', 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams(data)
          })
          .then(response => response.json())
          .then(json => {
            if(json.success) {
              passMsg.innerHTML = '<span class="text-success">Contrase√±a cambiada correctamente.</span>';
              setTimeout(function() { passMsg.innerHTML = ''; }, 1000);
              formCambioPass.style.display = 'none';
              divLectura.style.display = 'block';
              btnsTop.style.display = 'flex';
            } else {
              let msgError = '';
              let esObligatorio = false;
              if (typeof json.error === 'object') {
                for (const campo in json.error) {
                  let errores = json.error[campo];
                  if (Array.isArray(errores)) {
                    errores.forEach(function(err) {
                      msgError += `<div>${err}</div>`;
                      if (err === 'Este campo es obligatorio.') esObligatorio = true;
                    });
                  } else {
                    msgError += `<div>${errores}</div>`;
                    if (errores === 'Este campo es obligatorio.') esObligatorio = true;
                  }
                }
              } else {
                msgError = json.error || 'Error al cambiar la contrase√±a.';
              }
              passMsg.innerHTML = '<span class="text-danger">' + msgError + '</span>';
              if (!esObligatorio) {
                setTimeout(function() { passMsg.innerHTML = ''; }, 1000);
              } else {
                // Limpiar mensaje solo si el usuario escribe en alg√∫n campo
                var limpiarMsgObligatorio = function() {
                  passMsg.innerHTML = '';
                  passActual.removeEventListener('input', limpiarMsgObligatorio);
                  passNueva.removeEventListener('input', limpiarMsgObligatorio);
                  passNueva2.removeEventListener('input', limpiarMsgObligatorio);
                };
                passActual.addEventListener('input', limpiarMsgObligatorio);
                passNueva.addEventListener('input', limpiarMsgObligatorio);
                passNueva2.addEventListener('input', limpiarMsgObligatorio);
              }
            }
          })
          .catch(() => {
            passMsg.innerHTML = '<span class="text-danger">Error de red.</span>';
          });
        });
      }
    });
    </script>
    <script src="{% static 'principal/js/scripts.js'%}"></script>

    <script src="{% static 'principal/assets/demo/chart-bar-demo.js'%}"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/umd/simple-datatables.min.js"
      crossorigin="anonymous"
    ></script>
    <script src="{% static 'principal/js/datatables-simple-demo.js'%}"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
      // Filtro de men√∫ lateral mejorado
      const searchInput = document.getElementById('navbarSearch');
      const searchButton = document.getElementById('btnNavbarSearch');

      function filtrarMenu() {
        const search = (searchInput && searchInput.value || '').toLowerCase();
        document.querySelectorAll('.sb-sidenav-menu .nav-link, .sb-sidenav-menu-nested .nav-link').forEach(function(link) {
          const text = (link.textContent || '').toLowerCase();
          if (text.includes(search)) {
            link.style.display = '';
          } else {
            link.style.display = 'none';
          }
        });
        document.querySelectorAll('.collapse').forEach(function(collapse) {
          const visible = Array.from(collapse.querySelectorAll('.nav-link')).some(l => l.style.display !== 'none');
          if (visible) {
            collapse.classList.add('show');
            collapse.style.display = '';
          } else {
            collapse.classList.remove('show');
            collapse.style.display = 'none';
          }
        });
      }

      if (searchInput) searchInput.addEventListener('input', filtrarMenu);
      if (searchButton) searchButton.addEventListener('click', filtrarMenu);

      // Top 10 productos m√°s pedidos (se mantiene el gr√°fico horizontal)
      const myAreaEl = document.getElementById('myAreaChart');
      if (myAreaEl) {
        fetch('/dashboard/top-10-productos/')
          .then(response => response.json())
          .then(({ labels, data }) => {
            if (!labels || labels.length === 0 || !data || data.length === 0) {
              // Mostrar mensaje de advertencia si no hay datos
              const parent = myAreaEl.parentElement;
              let advertencia = document.getElementById('advertencia-top10');
              if (!advertencia) {
                advertencia = document.createElement('div');
                advertencia.id = 'advertencia-top10';
                advertencia.className = 'alert alert-warning mt-3';
                advertencia.innerText = 'No hay datos suficientes para mostrar el gr√°fico de Top 10 productos m√°s pedidos.';
                parent.appendChild(advertencia);
              }
              myAreaEl.style.display = 'none';
              return;
            } else {
              // Mensaje si no hay datos en el grafico top 10
              myAreaEl.style.display = '';
              const advertencia = document.getElementById('advertencia-top10');
              if (advertencia) advertencia.remove();
            }
            const ctx = myAreaEl.getContext('2d');
            new Chart(ctx, {
              type: 'bar',
              data: {
                labels: labels,
                datasets: [{
                  label: 'Cantidad Pedida',
                  data: data,
                  backgroundColor: 'rgba(255, 166, 0, 0.7)',
                  borderColor: 'rgba(255, 136, 0, 1)',
                  borderWidth: 1
                }]
              },
              options: {
                indexAxis: 'y',
                responsive: true,
                plugins: {
                  legend: { display: false },
                  tooltip: { mode: 'index', intersect: false },
                  datalabels: {
                    anchor: 'end',
                    align: 'right',
                    color: '#000',
                    font: { weight: 'bold' },
                    formatter: function(value) {
                      return value;
                    }
                  }
                },
                scales: {
                  x: { beginAtZero: true },
                  y: { beginAtZero: true }
                }
              },
              plugins: [ChartDataLabels]
            });
          });
      }

      // Tabla de productos por debajo del stock m√≠nimo
      const tablaStock = document.getElementById('tabla-stock-minimo');
      const mensajeVacio = document.getElementById('mensaje-stock-vacio');
      if (tablaStock) {
        fetch('/dashboard/productos-stock-minimo/')
          .then(response => response.json())
          .then(productos => {
            if (productos.length === 0) {
              if (mensajeVacio) mensajeVacio.style.display = '';
            } else {
              if (mensajeVacio) mensajeVacio.style.display = 'none';
              productos.forEach(prod => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${prod.nombre}</td><td>${prod.stock_actual}</td><td>${prod.stock_minimo}</td>`;
                tablaStock.appendChild(tr);
              });
            }
          });
      }
    });
    </script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const body = document.body;
        const navbarBrand = document.getElementById('navbarBrand');
        function updateNavbarBrand() {
          const isMinimized = body.classList.contains('sb-sidenav-toggled');
          navbarBrand.style.display = isMinimized ? 'none' : '';
        }
        updateNavbarBrand();
        const observer = new MutationObserver(updateNavbarBrand);
        observer.observe(body, { attributes: true, attributeFilter: ['class'] });
      });
    </script>
  </body>
</html>
