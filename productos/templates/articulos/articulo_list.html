{% extends 'dashboard/principal.html' %} {% block Contenido %}
<script>
  document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', function() {
      this.form.submit();
    });
  });
</script>
<div class="container-fluid px-4">
  <h1 class="mt-4">Mis articulos</h1>
  <hr style="height: 5px; background-color: black; border: none" />
  <!-- Fila de funciones generales -->
  <div class="d-flex justify-content-between align-items-center py-2">
    <!-- Botones de acciones -->
    <div class="d-flex gap-2 flex-wrap">
      <a href="{% url 'nuevo_articulo' %}" 
        class="btn btn-primary btn-sm d-flex align-items-center justify-content-center px-4">
        Nuevo artículo
      </a>
      <a href="{% url 'carga_masiva_productos' %}" 
        class="btn btn-success btn-sm d-flex align-items-center justify-content-center px-4">
        <i class="fas fa-file-excel me-2"></i> Carga masiva
      </a>
      <a href="{% url 'exportar_productos' %}" 
        class="btn btn-outline-primary btn-sm d-flex align-items-center justify-content-center px-3"
        data-bs-toggle="tooltip" 
        data-bs-placement="top" 
        title="Descargar lista de productos">
        <i class="fa-solid fa-download"></i>
      </a>
    </div>
    
    <!-- Filtros y buscador -->
    <div class="d-flex align-items-end gap-3 flex-wrap">
      <!-- Filtros + Buscador (UN SOLO FORMULARIO) -->
      <form method="get" class="d-flex align-items-end gap-3 flex-wrap">

        <!-- Estado -->
        <div class="dropdown">
          <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            Estado
          </button>
          <ul class="dropdown-menu p-2">
            <li>
              <div class="form-check mb-0">
                <input class="form-check-input" type="checkbox" name="estado" value="activos"
                id="estado_activos" {% if "activos" in filtro_estados %}checked{% endif %}>
                <label class="form-check-label" for="estado_activos">Activos</label>
              </div>
            </li>
            <li>
              <div class="form-check mb-0">
                <input class="form-check-input" type="checkbox" name="estado" value="inactivos"
                id="estado_inactivos" {% if "inactivos" in filtro_estados %}checked{% endif %}>
                <label class="form-check-label" for="estado_inactivos">Inactivos</label>
              </div>
            </li>
          </ul>
        </div>

        <!-- Categorías -->
        <div class="dropdown">
          <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            Categorías
          </button>
          <ul class="dropdown-menu p-2" style="max-height: 200px; overflow-y: auto;">
            {% for cat in categorias %}
              <li>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="categoria" value="{{ cat.id }}"
                  id="cat{{ cat.id }}" {% if cat.id|stringformat:"s" in filtro_categorias %}checked{% endif %}>
                  <label class="form-check-label" for="cat{{ cat.id }}">{{ cat.nombre }}</label>
                </div>
              </li>
            {% endfor %}
          </ul>
        </div>

        <!-- Proveedores -->
        <div class="dropdown">
          <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            Proveedores
          </button>
          <ul class="dropdown-menu p-2" style="max-height: 200px; overflow-y: auto;">
            {% for p in proveedores %}
              <li>
                <div class="form-check mb-0">
                  <input class="form-check-input" type="checkbox" name="proveedor" value="{{ p.id }}"
                  id="prov{{ p.id }}" {% if p.id|stringformat:"s" in filtro_proveedores %}checked{% endif %}>
                  <label class="form-check-label" for="prov{{ p.id }}">{{ p.nombreEmpresa }}</label>
                </div>
              </li>
            {% endfor %}
          </ul>
        </div>

        <!-- Buscador -->
        <div class="d-flex align-items-end gap-2">
          <input type="text" name="buscar" class="form-control form-control-sm" placeholder="Buscar artículo..." value="{{ request.GET.buscar }}">
        </div>

        <!-- Botón filtrar -->
        <button type="submit" class="btn btn-sm btn-primary mb-0">Filtrar</button>

        <!-- Botón restablecer filtros -->
        {% if filtros_activos or request.GET.buscar %}
          <a href="{% url 'mis_articulos' %}" class="btn btn-outline-danger btn-sm" title="Restablecer filtros">
            <i class="fa-solid fa-rotate-left"></i>
          </a>
        {% endif %}
      </form>
    </div>
  </div>
  <!-- Aca esta el mostrador de porque se esta filtrando -->
  <div>
  {% if filtros_activos or request.GET.buscar %}
    <div class="text-secondary small mt-3">
      <strong>Se está filtrando por:</strong>
      {% comment %} Estados {% endcomment %}
      {% if filtro_estados %}
        Estado:
        <span>
          {% if "activos" in filtro_estados %}<strong>Activos</strong>{% endif %}
          {% if "activos" in filtro_estados and "inactivos" in filtro_estados %} y {% endif %}
          {% if "inactivos" in filtro_estados %}<strong>Inactivos</strong>{% endif %}
        </span>
      {% endif %}
      {% if filtro_categorias %}
        {% if filtro_estados %}, {% endif %}
        Categoría/s:
        <span>
          {% for id in filtro_categorias %}
            {% for cat in categorias %}
              {% if cat.id|stringformat:"s" == id %}
                <strong>{{ cat.nombre }}</strong>{% if not forloop.last or not forloop.parentloop.last %}, {% endif %}
              {% endif %}
            {% endfor %}
          {% endfor %}
        </span>
      {% endif %}
      {% if filtro_proveedores %}
        {% if filtro_estados or filtro_categorias %}, {% endif %}
        Proveedor/es:
        <span>
          {% for id in filtro_proveedores %}
            {% for prov in proveedores %}
              {% if prov.id|stringformat:"s" == id %}
                <strong>{{ prov.nombreEmpresa }}</strong>{% if not forloop.last or not forloop.parentloop.last %}, {% endif %}
              {% endif %}
            {% endfor %}
          {% endfor %}
        </span>
      {% endif %}
      {% if request.GET.buscar %}
        {% if filtro_estados or filtro_categorias or filtro_proveedores %}, {% endif %}
        Búsqueda de texto: <span><strong>"{{ request.GET.buscar }}"</strong></span>
      {% endif %}
    </div>
  {% endif %}
</div>



  <hr style="height: 5px; background-color: black; border: none" />
  <table class="table table-striped table-bordered text-center">
    <thead>
      <tr>
        <th class="text-center">Acciones</th>
        <th class="text-center">Nombre</th>
        <th class="text-center">Marca</th>
        <th class="text-center">Precio $</th>
        <th class="text-center">Stock</th>
        <th class="text-center">Categoria</th>
        <th class="text-center">Proveedores</th>
        <th class="text-center">Ultimo Ingreso</th>
        <th class="text-center">Activo</th>
      </tr>
    <thead>
    <tbody> 
      {% for p in articulos %}
      <tr id="articulo-{{ p.id }}">
<td class="text-center">
  {% if request.user.is_staff %}
    <a href="{% url 'usuarios:editar_usuario' user.pk %}"
       class="btn btn-outline-success mt-2"
       style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;"
       title="Editar">
      <i class="fa fa-edit fa-sm"></i>
    </a>

    <button type="button"
            class="btn btn-outline-danger mt-2"
            data-bs-toggle="modal"
            data-bs-target="#modalEliminarUsuario{{ user.pk }}"
            data-id="{{ user.pk }}"
            data-nombre="{{ user.username }}"
            style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;"
            title="Eliminar">
      <i class="fa fa-trash fa-sm"></i>
    </button>

    <!-- Modal -->
    <div class="modal fade" id="modalEliminarUsuario{{ user.pk }}" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">¿Eliminar usuario?</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            ¿Seguro que querés eliminar a <strong>{{ user.username }}</strong>?
          </div>
          <div class="modal-footer">
            <button type="button"
                    class="btn btn-danger btn-confirmar-eliminar-usuario"
                    data-id="{{ user.pk }}"
                    data-bs-dismiss="modal">
              Eliminar
            </button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  <a href="{% url 'usuarios:detalle_usuario' user.pk %}"
     class="btn btn-outline-primary mt-2"
     style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;"
     title="Ver">
    <i class="fa fa-eye fa-sm"></i>
  </a>
</td>
        <td>{{p.nombre}}</td>
        <td class="text-center">{{p.marca}}</td>
        <td class="text-center">{{p.precio}}</td>
        <td class="text-center">{{p.stock}}</td>
        <td class="text-center">{{p.categoria}}</td>
        <td>
          {% if p.proveedores.exists %}
            {% for pro in p.proveedores.all %}
              {{ pro.nombreEmpresa }}{% if not forloop.last %}, {% endif %}
            {% endfor %}
          {% else %}
            <em>Sin proveedor</em>
          {% endif %}
        </td>
        <td class="text-center">{{ p.fecha_ultimo_ingreso|date:"d/m/Y" }}</td>
        <td>
          {% if p.activo %}
            <i class="fas fa-check-square text-success"></i>
          {% else %}
            <i class="fas fa-times-square text-danger"></i>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock Contenido %}

{% block footer %}
<tfoot>
  <tr>
    <td colspan="9">
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center mb-0">

          <!-- Flecha anterior -->
          {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link"
               href="?{% if request.GET %}{{ request.GET.urlencode|cut:'page='|cut:'&page=' }}&{% endif %}page={{ page_obj.previous_page_number }}"
               aria-label="Anterior">
              &laquo;
            </a>
          </li>
          {% else %}
          <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
          {% endif %}

          <!-- Primera página -->
          {% if page_obj.number != 1 %}
          <li class="page-item">
            <a class="page-link"
               href="?{% if request.GET %}{{ request.GET.urlencode|cut:'page='|cut:'&page=' }}&{% endif %}page=1">
              1
            </a>
          </li>
          {% else %}
          <li class="page-item active"><span class="page-link">1</span></li>
          {% endif %}

          <!-- Puntos suspensivos si hay más de 3 páginas antes del bloque -->
          {% if page_obj.number > 4 %}
          <li class="page-item disabled"><span class="page-link">...</span></li>
          {% endif %}

          <!-- Bloque central (páginas cercanas) -->
          {% for num in page_obj.paginator.page_range %}
            {% if num != 1 and num != page_obj.paginator.num_pages %}
              {% if num >= page_obj.number|add:"-2" and num <= page_obj.number|add:"2" %}
                {% if num == page_obj.number %}
                  <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% else %}
                  <li class="page-item">
                    <a class="page-link"
                       href="?{% if request.GET %}{{ request.GET.urlencode|cut:'page='|cut:'&page=' }}&{% endif %}page={{ num }}">
                      {{ num }}
                    </a>
                  </li>
                {% endif %}
              {% endif %}
            {% endif %}
          {% endfor %}

          <!-- Puntos suspensivos si hay más de 3 páginas después del bloque -->
          {% if page_obj.number < page_obj.paginator.num_pages|add:"-3" %}
          <li class="page-item disabled"><span class="page-link">...</span></li>
          {% endif %}

          <!-- Última página -->
          {% if page_obj.number != page_obj.paginator.num_pages %}
          <li class="page-item">
            <a class="page-link"
               href="?{% if request.GET %}{{ request.GET.urlencode|cut:'page='|cut:'&page=' }}&{% endif %}page={{ page_obj.paginator.num_pages }}">
              {{ page_obj.paginator.num_pages }}
            </a>
          </li>
          {% else %}
          <li class="page-item active"><span class="page-link">{{ page_obj.paginator.num_pages }}</span></li>
          {% endif %}

          <!-- Flecha siguiente -->
          {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link"
               href="?{% if request.GET %}{{ request.GET.urlencode|cut:'page='|cut:'&page=' }}&{% endif %}page={{ page_obj.next_page_number }}"
               aria-label="Siguiente">
              &raquo;
            </a>
          </li>
          {% else %}
          <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
          {% endif %}

        </ul>
      </nav>
    </td>
  </tr>
</tfoot>

<script>
document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll(".btn-confirmar-eliminar").forEach(btn => {
    btn.addEventListener("click", function () {
      const id = this.dataset.id;

      fetch("{% url 'eliminar_articulo' 0 %}".replace("/0/", `/${id}/`), {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "X-Requested-With": "XMLHttpRequest"
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          document.getElementById(`articulo-${id}`).remove();
        } else {
          alert("Error al eliminar el artículo.");
        }
      });
    });
  });
});
</script>

{% endblock footer %}

