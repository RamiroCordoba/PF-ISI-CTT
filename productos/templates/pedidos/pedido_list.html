{% extends 'dashboard/principal.html' %}
{% block Contenido %}
<div class="container-fluid px-4">
  <h1 class="mt-4">Pedidos</h1>
  <hr style="height: 5px; background-color: black; border: none" />

  <!-- Fila de funciones generales -->
  <div class="d-flex justify-content-between align-items-center py-2">
    <!-- Botones de acciones -->
    <div class="d-flex gap-2 flex-wrap">
      <a href="{% url 'nuevo_pedido' %}" class="btn btn-primary btn-sm d-flex align-items-center justify-content-center px-4">
        Nuevo pedido
      </a>
    </div>

    <!-- Filtros y buscador -->
    <div class="d-flex align-items-end gap-3 flex-wrap">
      <form method="get" class="d-flex align-items-end gap-3 flex-wrap">
        <!-- Rango de fechas -->
        <div class="d-flex flex-column">
          <label class="form-label mb-0">Desde:</label>
          <input type="date" name="fecha_inicio" class="form-control form-control-sm" value="{{ request.GET.fecha_inicio }}">
        </div>
        <div class="d-flex flex-column">
          <label class="form-label mb-0">Hasta:</label>
          <input type="date" name="fecha_fin" class="form-control form-control-sm" value="{{ request.GET.fecha_fin }}">
        </div>
        <!-- Completado -->
        <div class="dropdown">
          <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
            Estado
          </button>
          <ul class="dropdown-menu p-2">
            <li>
              <div class="form-check mb-0">
                <input class="form-check-input" type="checkbox" name="estado" value="completado"
                       id="estado_completado" {% if "completado" in filtro_estados %}checked{% endif %}>
                <label class="form-check-label" for="estado_completado">Completado</label>
              </div>
            </li>
            <li>
              <div class="form-check mb-0">
                <input class="form-check-input" type="checkbox" name="estado" value="pendiente"
                       id="estado_pendiente" {% if "pendiente" in filtro_estados %}checked{% endif %}>
                <label class="form-check-label" for="estado_pendiente">Pendiente</label>
              </div>
            </li>
          </ul>
        </div>

        <!-- Proveedores -->
        <div class="dropdown">
          <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
            Proveedor
          </button>
          <ul class="dropdown-menu p-2" style="max-height: 200px; overflow-y: auto;">
            {% for p in proveedores %}
              <li>
                <div class="form-check mb-0">
                  <input class="form-check-input" type="checkbox" name="proveedor" value="{{ p.id }}"
                         id="prov{{ p.id }}" {% if p.id|stringformat:"s" in filtro_proveedores %}checked{% endif %}>
                  <label class="form-check-label" for="prov{{ p.id }}">{{ p.nombreEmpresa }}</label>
                </div>
              </li>
            {% endfor %}
          </ul>
        </div>

        <!-- Buscador -->
        <div class="d-flex align-items-end gap-2">
          <input type="text" name="buscar" class="form-control form-control-sm" placeholder="Buscar pedido..." value="{{ request.GET.buscar }}">
        </div>

        <!-- Botón filtrar -->
        <button type="submit" class="btn btn-sm btn-primary mb-0">Filtrar</button>

        <!-- Botón restablecer filtros -->
        {% if filtros_activos or request.GET.buscar %}
          <a href="{% url 'listar_pedidos' %}" class="btn btn-outline-danger btn-sm" title="Restablecer filtros">
            <i class="fa-solid fa-rotate-left"></i>
          </a>
        {% endif %}
      </form>
    </div>
  </div>

  <!-- Indicador de filtros activos -->
  {% if filtros_activos or request.GET.buscar %}
  <div class="text-secondary small mt-3">
    Se está filtrando por
    {% if filtro_estados %}
      {% if "completado" in filtro_estados %} pedidos completados{% endif %}
      {% if "pendiente" in filtro_estados %}
        {% if "completado" in filtro_estados %} y{% endif %} pedidos pendientes
      {% endif %}
    {% endif %}
    {% if filtro_proveedores %}
      {% if filtro_estados %},{% endif %} con proveedor/es
      {% for id in filtro_proveedores %}
        {% for prov in proveedores %}
          {% if prov.id|stringformat:"s" == id %}
            {{ prov.nombreEmpresa }}{% if not forloop.last %}, {% endif %}
          {% endif %}
        {% endfor %}
      {% endfor %}
    {% endif %}
    {% if request.GET.buscar %}
      {% if filtro_estados or filtro_proveedores %},{% endif %}
      que coinciden con: "<strong>{{ request.GET.buscar }}</strong>"
    {% endif %}.
  </div>
  {% endif %}

  <hr style="height: 5px; background-color: black; border: none" />

  <!-- Tabla de pedidos -->
  <table class="table table-striped table-bordered text-center">
    <thead>
      <tr>
        <th class="text-center">Acciones</th>
        <th class="text-center">ID</th>
        <th class="text-center">Proveedor</th>
        <th class="text-center">Fecha</th>
        <th class="text-center">Fecha Ingreso</th>
        <th class="text-center">Comentarios</th>
        <th class="text-center">Completado</th>
      </tr>
    </thead>
    <tbody>
      {% for pedido in pedidos %}
      <tr>
        <td class="text-center">
          {% if request.user.is_staff %}
            <a href="{% url 'editar_pedido' pedido.id %}" class="btn btn-outline-success mt-2" style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;">
          <i class="fa fa-edit fa-sm" title="Editar"></i>
          </a>
<!-- Botón que abre el modal -->
<button type="button"
        class="btn btn-outline-danger mt-2"
        data-bs-toggle="modal"
        data-bs-target="#modalEliminarPedido{{ pedido.id }}"
        style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;"
        title="Eliminar">
  <i class="fa fa-trash fa-sm"></i>
</button>

<!-- Modal de confirmación -->
<div class="modal fade" id="modalEliminarPedido{{ pedido.id }}" tabindex="-1" aria-labelledby="modalEliminarPedidoLabel{{ pedido.id }}" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalEliminarPedidoLabel{{ pedido.id }}">Confirmar eliminación</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        ¿Estás seguro de que querés eliminar el pedido <strong>#{{ pedido.id }}</strong>?
      </div>
      <div class="modal-footer">
  <form method="post" action="{% url 'eliminar_pedido' pedido.id %}?debug=1">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">Eliminar</button>
        </form>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
      </div>
    </div>
  </div>
</div>

          <a href="{% url 'detalle_de_pedido' pedido.id %}" class="btn btn-outline-primary mt-2"
             style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;">
            <i class="fa-solid fa-eye" title="Ver"></i>
          </a>
          <a href="{% url 'pedido_pdf' pedido.id %}" class="btn btn-outline-dark mt-2"
            style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;"
            title="Descargar PDF" target="_blank">
            <i class="fa-solid fa-download"></i>
          </a>
        {% endif %}
        </td>
        <td>{{ pedido.id }}</td>
        <td>{{ pedido.proveedor.nombreEmpresa }}</td>
        <td>{{ pedido.fecha|date:"d/m/Y" }}</td>
        <td>{{ pedido.fechaIngreso|default:"-" }}</td>
        <td>{{ pedido.comentarios|default:"-" }}</td>
        <td>
          {% if pedido.completado %}
            <span class="badge bg-success">Sí</span>
          {% else %}
            <span class="badge bg-secondary">No</span>
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="7">No hay pedidos registrados.</td>
      </tr>
      {% endfor %}
    </tbody>
    <tfoot>
      <tr>
        <td colspan="9">
          <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center mb-0">

              <!-- Flecha anterior -->
              {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link"
                   href="?{% if request.GET %}{{ request.GET.urlencode|cut:'page='|cut:'&page=' }}&{% endif %}page={{ page_obj.previous_page_number }}"
                   aria-label="Anterior">
                  &laquo;
                </a>
              </li>
              {% else %}
              <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
              {% endif %}

              <!-- Primera página -->
              {% if page_obj.number != 1 %}
              <li class="page-item">
                <a class="page-link"
                   href="?{% if request.GET %}{{ request.GET.urlencode|cut:'page='|cut:'&page=' }}&{% endif %}page=1">
                  1
                </a>
              </li>
              {% else %}
              <li class="page-item active"><span class="page-link">1</span></li>
              {% endif %}

              <!-- Puntos suspensivos si hay más de 3 páginas antes del bloque -->
              {% if page_obj.number > 4 %}
              <li class="page-item disabled"><span class="page-link">...</span></li>
              {% endif %}

              <!-- Bloque central (páginas cercanas) -->
              {% for num in page_obj.paginator.page_range %}
                {% if num != 1 and num != page_obj.paginator.num_pages %}
                  {% if num >= page_obj.number|add:"-2" and num <= page_obj.number|add:"2" %}
                    {% if num == page_obj.number %}
                      <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                    {% else %}
                      <li class="page-item">
                        <a class="page-link"
                           href="?{% if request.GET %}{{ request.GET.urlencode|cut:'page='|cut:'&page=' }}&{% endif %}page={{ num }}">
                          {{ num }}
                        </a>
                      </li>
                    {% endif %}
                  {% endif %}
                {% endif %}
              {% endfor %}

              <!-- Puntos suspensivos si hay más de 3 páginas después del bloque -->
              {% if page_obj.number < page_obj.paginator.num_pages|add:"-3" %}
              <li class="page-item disabled"><span class="page-link">...</span></li>
              {% endif %}

              <!-- Última página -->
              {% if page_obj.number != page_obj.paginator.num_pages %}
              <li class="page-item">
                <a class="page-link"
                   href="?{% if request.GET %}{{ request.GET.urlencode|cut:'page='|cut:'&page=' }}&{% endif %}page={{ page_obj.paginator.num_pages }}">
                  {{ page_obj.paginator.num_pages }}
                </a>
              </li>
              {% else %}
              <li class="page-item active"><span class="page-link">{{ page_obj.paginator.num_pages }}</span></li>
              {% endif %}

              <!-- Flecha siguiente -->
              {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link"
                   href="?{% if request.GET %}{{ request.GET.urlencode|cut:'page='|cut:'&page=' }}&{% endif %}page={{ page_obj.next_page_number }}"
                   aria-label="Siguiente">
                  &raquo;
                </a>
              </li>
              {% else %}
              <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
              {% endif %}

            </ul>
          </nav>
        </td>
      </tr>
    </tfoot>

  </table>
</div>

<script>
  document.querySelector("form").addEventListener("submit", function() {
    document.querySelectorAll(".dropdown-menu").forEach(menu => {
      menu.classList.add("show");
    });
  });
</script>

{% endblock %}
