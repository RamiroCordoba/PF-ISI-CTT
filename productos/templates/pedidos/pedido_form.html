{% extends 'dashboard/principal.html' %}
{% load static %}
{% block Contenido %}

<div class="container-fluid px-4" style="background-color: #f5f6fa; min-height: 100vh;">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-10">
      <div class="card border-0 mt-4 shadow-lg" style="min-width: 900px; box-shadow: 0 6px 32px 0 rgba(0,0,0,0.10), 0 1.5px 6px 0 rgba(0,0,0,0.08);">
        <div class="card-header text-white text-center py-3 rounded-top" style="background: #ff8800;">
          <h3 class="mb-0">
            {% if form.instance.pk %}
              <i class="fa fa-edit me-2"></i>Editar pedido
            {% else %}
              <i class="fa fa-plus me-2"></i>Nuevo pedido
            {% endif %}
          </h3>
        </div>
        <div class="card-body bg-white">
          <form method="post" id="pedidoForm">
            {% csrf_token %}
            {{ formset.management_form }}

            <!-- Datos del pedido -->
            <div class="row">
              <div class="col-md-6">
                {% if form.instance.pk %}
                  <div class="mb-4">
                    <label class="form-label fw-semibold" style="color:#ff8800;"><i class="fa fa-industry me-2"></i>Proveedor</label>
                    <div style="position:relative; background:linear-gradient(90deg,#fff3e0 0%,#ffe0b2 100%); border-radius:0.7rem; box-shadow:0 2px 8px rgba(255,136,0,0.08); border:2px solid #ff8800; padding:0.7rem;">
                      <input type="hidden" name="proveedor" value="{{ form.instance.proveedor.id }}">
                      <input type="text" class="form-control border-0" value="{{ form.instance.proveedor.nombreEmpresa }}" readonly style="background:transparent;">
                    </div>
                  </div>
                {% else %}
                  <div class="mb-4">
                    <label class="form-label fw-semibold" style="color:#ff8800;"><i class="fa fa-industry me-2"></i>Proveedor</label>
                    <div style="position:relative; background:linear-gradient(90deg,#fff3e0 0%,#ffe0b2 100%); border-radius:0.7rem; box-shadow:0 2px 8px rgba(255,136,0,0.08); border:2px solid #ff8800; padding:0.7rem;">
                      <select name="proveedor" id="id_proveedor" class="form-select form-select-lg border-0" style="width:100%; background:transparent; appearance:none; padding-right:2.2em;">
                        <option value="">-- Seleccione proveedor --</option>
                        {% for option in form.proveedor.field.choices %}
                          <option value="{{ option.0 }}" {% if option.0 == form.proveedor.value %}selected{% endif %}>{{ option.1 }}</option>
                        {% endfor %}
                      </select>
                      <span style="position:absolute; right:1.2em; top:50%; transform:translateY(-50%); pointer-events:none; font-size:1.3em; color:#ff8800;">
                        <i class="fa fa-chevron-down"></i>
                      </span>
                    </div>
                    <div id="proveedor-error" class="text-danger mt-1"></div>
                  </div>
                {% endif %}

                <!-- Forma de pago -->
                <div class="mb-4">
                  <label class="form-label fw-semibold" style="color:#ff8800;"><i class="fa fa-credit-card me-2"></i>Forma de pago</label>
                  <div style="position:relative; background:linear-gradient(90deg,#fff3e0 0%,#ffe0b2 100%); border-radius:0.7rem; box-shadow:0 2px 8px rgba(255,136,0,0.08); border:2px solid #ff8800; padding:0.7rem;">
                    <select name="forma_pago" id="id_forma_pago" class="form-select form-select-lg border-0" style="width:100%; background:transparent; appearance:none; padding-right:2.2em;">
                      <option value="">-- Seleccione forma de pago --</option>
                      {% for option in form.forma_pago.field.choices %}
                        <option value="{{ option.0 }}" {% if option.0 == form.forma_pago.value %}selected{% endif %}>{{ option.1 }}</option>
                      {% endfor %}
                    </select>
                    <span style="position:absolute; right:1.2em; top:50%; transform:translateY(-50%); pointer-events:none; font-size:1.3em; color:#ff8800;">
                      <i class="fa fa-chevron-down"></i>
                    </span>
                  </div>
                  <div id="forma_pago-error" class="text-danger mt-1"></div>
                </div>

                <!-- Fecha estimada -->
                {% if not form.instance.pk %}
                  <div class="mb-4">
                    <label for="{{ form.fechaEstimadaEntrega.id_for_label }}" class="form-label fw-semibold" style="color:#ff8800;">{{ form.fechaEstimadaEntrega.label }}</label>
                    <div style="position:relative; background:linear-gradient(90deg,#fff3e0 0%,#ffe0b2 100%); border-radius:0.7rem; box-shadow:0 2px 8px rgba(255,136,0,0.08); border:2px solid #ff8800; padding:0.7rem;">
                      <input type="date" name="fechaEstimadaEntrega" id="{{ form.fechaEstimadaEntrega.id_for_label }}" class="form-control border-0" style="width:100%; background:transparent; padding-right:2.2em;" value="{{ form.fechaEstimadaEntrega.value|default_if_none:'' }}">
                    </div>
                    <div id="fecha-error" class="text-danger mt-1"></div>
                  </div>
                {% endif %}
              </div>
            </div>

            <!-- Comentarios -->
            <div class="row">
              <div class="col-12">
                <div class="mb-4">
                  <label for="id_comentarios" class="form-label fw-semibold" style="color:#ff8800;"><i class="fa fa-comment-dots me-2"></i>Comentarios</label>
                  <div style="background:linear-gradient(90deg,#fff3e0 0%,#ffe0b2 100%); border-radius:0.7rem; box-shadow:0 2px 8px rgba(255,136,0,0.08); border:2px solid #ff8800; padding:1rem;">
                    <textarea name="comentarios" class="form-control form-control-lg border-0" id="id_comentarios" rows="3" style="background:transparent; resize:vertical; font-size:1.08em;">{{ form.comentarios.value|default_if_none:'' }}</textarea>
                  </div>
                  {% if form.comentarios.errors %}
                    <div class="text-danger small mt-1">{{ form.comentarios.errors }}</div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Productos -->
            <div class="row">
              <div class="col-12">
                <h5 class="fw-bold" style="color:#ff8800;"><i class="fa fa-boxes me-2"></i>Productos del pedido</h5>
                <div class="table-responsive" style="border-radius:0.7rem; box-shadow:0 2px 8px rgba(255,136,0,0.08); border:2px solid #ff8800; background:linear-gradient(90deg,#fff3e0 0%,#ffe0b2 100%); padding:1rem;">
                  <table class="table table-bordered align-middle mb-0" id="pedido-items-table" style="background:#fff; border-radius:0.5rem; overflow:hidden;">
                    <thead class="table-dark">
                      <tr style="font-size:1.07em;">
                        <th style="background:#ff8800; color:#fff;">Producto</th>
                        <th style="background:#ff8800; color:#fff;">Cantidad</th>
                        <th style="background:#ff8800; color:#fff;">Precio</th>
                        <th style="background:#ff8800; color:#fff;">Subtotal</th>
                        {% if not form.instance.completado %}
                          <th style="background:#ff8800; color:#fff;">Acciones</th>
                        {% endif %}
                      </tr>
                    </thead>
                    <tbody>
                      {% for item_form in formset %}
                        <tr class="pedido-item-row">
                          <td>
                            <input type="text" class="form-control producto-autocomplete" data-index="{{ forloop.counter0 }}" value="{% if item_form.instance.producto %}{{ item_form.instance.producto.nombre }}{% endif %}">
                            <input type="hidden" name="{{ item_form.producto.html_name }}" value="{{ item_form.instance.producto.id|default_if_none:'' }}">
                          </td>
                          <td>
                            <input type="number" name="{{ item_form.cantidad.html_name }}" class="form-control cantidad-input" min="0" step="1" value="{{ item_form.instance.cantidad|default_if_none:'' }}">
                          </td>
                          <td>
                            <input type="text" name="{{ item_form.precio.html_name }}" class="form-control precio-input" value="{{ item_form.instance.precio|default_if_none:'' }}">
                          </td>
                          <td class="subtotal-cell">0</td>
                          {% if not form.instance.completado %}
                            <td><button type="button" class="btn btn-danger btn-sm eliminar-fila-pedido">&times;</button></td>
                          {% endif %}
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                <div class="mt-2 text-end">
                  <strong style="color:#ff8800;">Total del pedido: $<span id="total-pedido">0</span></strong>
                </div>
                {% if not form.instance.completado %}
                  <button type="button" id="add-item-btn-pedido" class="btn my-2 px-4 text-white" style="background:#298f29;">Agregar producto</button>
                {% endif %}
              </div>
            </div>

            <!-- Botones -->
            <div class="d-flex justify-content-center gap-2 mt-4">
              {% if not form.instance.completado %}
                <input class="btn px-4 text-white" style="background:#ff8800;" type="submit" value="Guardar" />
              {% else %}
                <button class="btn btn-secondary px-4" disabled>Pedido confirmado</button>
              {% endif %}
              <button class="btn btn-secondary px-4" type="button" onclick="window.location.href='{% url "listar_pedidos" %}'">Cancelar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Plantilla oculta -->
<table style="display:none;">
  <tbody>
    <tr id="pedido-item-template" class="pedido-item-row">
      <td>
        <input type="text" class="form-control producto-autocomplete" data-index="__prefix__" value="">
        <input type="hidden" name="__prefix__-producto" value="">
      </td>
      <td>
        <input type="number" name="__prefix__-cantidad" class="form-control cantidad-input" min="0" step="1" value="">
      </td>
      <td>
        <input type="text" name="__prefix__-precio" class="form-control precio-input" value="">
      </td>
      <td class="subtotal-cell">0</td>
      <td>
        <button type="button" class="btn btn-danger btn-sm eliminar-fila-pedido">&times;</button>
      </td>
    </tr>
  </tbody>
</table>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script>
$(function(){

  function activarAutocomplete($scope){
    $scope = $scope || $(document);
    $scope.find(".producto-autocomplete").each(function(){
      const $input = $(this);
      const $hidden = $input.siblings("input[type='hidden']");
      if($input.data("ui-autocomplete")) return;

      $input.autocomplete({
        source: "{% url 'autocomplete_productos' %}",
        minLength: 2,
        select: function(event, ui){
          $input.val(ui.item.value);
          $hidden.val(ui.item.id);
          $input.closest("tr").find(".precio-input").val(parseFloat(ui.item.precio).toFixed(2));
          calcularTotales();
        }
      });
    });
  }

  function calcularTotales(){
    let total = 0;
    $("#pedido-items-table tbody tr").each(function(){
      const cantidad = parseFloat($(this).find(".cantidad-input").val()) || 0;
      const precio = parseFloat($(this).find(".precio-input").val()) || 0;
      const subtotal = cantidad * precio;
      $(this).find(".subtotal-cell").text(`$${subtotal.toFixed(2)}`);
      total += subtotal;
    });
    $("#total-pedido").text(total.toFixed(2));
  }

  function validarItems(){
    let valido=false;
    $("#pedido-items-table tbody tr").each(function(){
      const prod=$(this).find("input[type='hidden']").val();
      const cant=parseFloat($(this).find(".cantidad-input").val())||0;
      if(prod && cant>0) valido=true;
    });
    if(!valido){
      if($("#formset-errors").length===0)
        $("<div id='formset-errors' class='text-danger mt-2'></div>").insertBefore("#pedidoForm input[type='submit']");
      $("#formset-errors").text("Debe agregar al menos un producto con cantidad.");
    } else { $("#formset-errors").text(""); }
    return valido;
  }

  $("#add-item-btn-pedido").click(function(){
    const totalForms=$("#id_{{ formset.prefix }}-TOTAL_FORMS");
    const formIndex=parseInt(totalForms.val());

    const $template=$("#pedido-item-template").clone().removeAttr("id").show();
    $template.find("input, select").each(function(){
      const name=$(this).attr("name");
      if(name) $(this).attr("name",name.replace("__prefix__",formIndex));
    });

    $("#pedido-items-table tbody").append($template);
    totalForms.val(formIndex+1);

    activarAutocomplete($template);
    calcularTotales();
  });

  $(document).on("click",".eliminar-fila-pedido",function(){
    const $tbody=$("#pedido-items-table tbody");
    const totalForms=$("#id_{{ formset.prefix }}-TOTAL_FORMS");
    if($tbody.find("tr").length>1) $(this).closest("tr").remove();
    else {
      const $row=$tbody.find("tr:first");
      $row.find("input").val("");
      $row.find(".subtotal-cell").text("0");
    }
    totalForms.val($tbody.find("tr").length);
    calcularTotales();
    validarItems();
  });

  $(document).on("input",".cantidad-input,.precio-input",calcularTotales);

  $("#pedidoForm").on("submit",function(e){
    let valido=true;
    if($("#id_proveedor").length && !$("#id_proveedor").val()){ valido=false; $("#proveedor-error").text("Debe seleccionar un proveedor."); }
    else $("#proveedor-error").text("");

    if($("#id_forma_pago").length && !$("#id_forma_pago").val()){ valido=false; $("#forma_pago-error").text("Debe seleccionar una forma de pago."); }
    else $("#forma_pago-error").text("");

    if($("#id_fechaEstimadaEntrega").length && !$("#id_fechaEstimadaEntrega").val()){ valido=false; $("#fecha-error").text("Debe ingresar una fecha estimada de entrega."); }
    else $("#fecha-error").text("");

    if(!validarItems()) valido=false;
    if(!valido) e.preventDefault();
  });

  activarAutocomplete();
  calcularTotales();

});
</script>

{% endblock Contenido %}
